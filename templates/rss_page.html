<html>
<head>
	<!-- <link href="files/prism.css" rel="stylesheet" /> -->
	<link rel="stylesheet"
	      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/darcula.min.css">
	<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
</head>

<body>
	<!-- <script src="files/prism.js"></script> -->
	<h1>Notification feed</h1>
	<hr>
	<div id="list"></div>
</body>
</html>

<script>

var eventSource = new EventSource("/notification_server/notifications/{{ merchant_account }}");
var lastTimestamp = 0;

eventSource.onmessage = function(e) {

	// get data from event and json encode
	notification = JSON.parse(e.data.replace(/'/g, '"'));

	// if the event sent by the server is newer, add it to the page
	if (Date.parse(notification.eventDate) > lastTimestamp) {

		// create element to be added
		var notificationContainer = document.createElement("pre");
		var notificationElement = document.createElement("code");
		notificationContainer.appendChild(notificationElement);

		// set up new element
		if (document.querySelector(".first") != null) {
			document.querySelector(".first").classList.remove("first");
		}
		notificationElement.classList.add("json");
		notificationElement.classList.add("first");
		notificationElement.innerHTML = JSON.stringify(notification, null, 4);

		// add to DOM
		eventList = document.getElementById("list")
		eventList.insertBefore(notificationContainer, eventList.firstChild);

		// activate highlighting
		hljs.highlightBlock(notificationElement);

		// update current timestamp
		lastTimestamp = Date.parse(notification.eventDate);
	}
}

</script>

<style>

body {
	background: #2b2b2b;
}

h1 {
	color: #FFF;
	font-family: sans-serif;
}

code.first {
	background: #383838;
}

</style>